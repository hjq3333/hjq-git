暂定无线端用1，pc端用0

**无线端数据**



1.无线入店与承接

	**具体实现: 无线端的进店页面字段,进入店铺的访客数；相应商品的下单买家数，且是要算出一天里，七天里，一个月里分别的数据。**

	create table log(
        user_id int comment '用户ID',
        shop_id int comment '店铺ID',
        product_id int comment '商品ID',
        visitor_time timestamp comment '访问时间',
        page_type varchar(20) comment '页面类型',
        page_id int comment '页面ID',
        stay_time int comment '停留时长',
        is_wireless int comment '是否无线端',
        is_order int commrnt '是否下单(1=是,0=否)'
    );
    
    -- 1. 日维度数据（示例：2025-01-26）
    SELECT
        shop_id,
        page_id,
        page_type,
        '2025-01-26' AS stat_period,
        'day' AS period_type,
        COUNT(DISTINCT user_id) AS visitor_count,
        COUNT(DISTINCT CASE WHEN id_order = 1 THEN user_id END) AS order_buyer_count,
        ROUND(
            COUNT(DISTINCT CASE WHEN id_order = 1 THEN user_id END) / 
            NULLIF(COUNT(DISTINCT user_id), 0) * 100, 
            2
        ) AS conversion_rate_percent
    FROM log
    WHERE
        is_wireless = 1
    AND 
        visitor_time BETWEEN '2025-01-26 00:00:00' AND '2025-01-26 23:59:59'
    GROUP BY    
        shop_id, page_id, page_type
    
    UNION ALL
    
    -- 2. 7天维度数据（示例：2025-01-20至2025-01-26）
    SELECT
        shop_id,
        page_id,
        page_type,
        '2025-01-20~2025-01-26' AS stat_period,
        '7days' AS period_type,
        COUNT(DISTINCT user_id) AS visitor_count,
        COUNT(DISTINCT CASE WHEN id_order = 1 THEN user_id END) AS order_buyer_count,
        ROUND(
            COUNT(DISTINCT CASE WHEN id_order = 1 THEN user_id END) / 
            NULLIF(COUNT(DISTINCT user_id), 0) * 100, 
            2
        ) AS conversion_rate_percent
    FROM log
    WHERE
        is_wireless = 1
    AND     
        visitor_time BETWEEN '2025-01-20 00:00:00' AND '2025-01-26 23:59:59'
    GROUP BY 
        shop_id, page_id, page_type
    
    UNION ALL
    
    -- 3. 30天维度数据（示例：2024-12-27至2025-01-26）
    SELECT
        shop_id,
        page_id,
        page_type,
        '2024-12-27~2025-01-26' AS stat_period,
        '30days' AS period_type,
        COUNT(DISTINCT user_id) AS visitor_count,
        COUNT(DISTINCT CASE WHEN id_order = 1 THEN user_id END) AS order_buyer_count,
        ROUND(
            COUNT(DISTINCT CASE WHEN id_order = 1 THEN user_id END) / 
            NULLIF(COUNT(DISTINCT user_id), 0) * 100, 
            2
        ) AS conversion_rate_percent
    FROM log
    WHERE
        is_wireless = 1
    AND 
        visitor_time BETWEEN '2024-12-27 00:00:00' AND '2025-01-26 23:59:59'
    GROUP BY 
        shop_id, page_id, page_type;



2.页面访问排行

    具体实现:
    店铺页:求出店铺内包含的首页、活动页等的浏览量和停留时长和访客量并按浏览量排序
        
        -- 统计店铺内不同类型页面的浏览量、停留时长和访客量
        SELECT
            shop_id,
            page_type,
            COUNT(*) AS view_count,               -- 浏览量(PV)
            SUM(stay_time) AS total_stay_time,    -- 总停留时长
            COUNT(DISTINCT user_id) AS visitor_count  -- 访客量(UV)
        FROM log
        WHERE
            is_wireless = 1                       -- 限定无线端
        AND 
            page_type IN ('首页', '活动页')   -- 限定店铺内页面类型
        GROUP BY 
            shop_id, page_type
        ORDER BY 
            view_count DESC;                 -- 按浏览量降序排序

    商品详情页:商品基础详情页的浏览量和停留时长和访客量并按浏览量排序 
    
    SELECT 
        l.shop_id,                   -- 店铺ID
        COUNT(*) AS view_count,      -- 浏览量(PV)
        SUM(l.stay_time) AS total_stay_time,  -- 总停留时长
        COUNT(DISTINCT l.user_id) AS visitor_count,  -- 访客数(UV)
        AVG(l.stay_time) AS avg_stay_time  -- 平均停留时长
    FROM log l
    WHERE
        l.is_wireless = 1            -- 限定无线端数据
        AND l.page_type IN ('商品详情页')  -- 限定商品详情页类型
    GROUP BY
        l.product_id
    ORDER BY
        view_count DESC;             -- 按浏览量降序排列
         
    店铺其他页:除去上面两个，各种页面的浏览量和停留时长和访客量并按浏览量排序
    
    -- 店铺其他页（非首页、活动页、商品详情页等）统计
    SELECT
        l.shop_id,                   -- 店铺ID
        l.page_type,                 -- 页面类型
        COUNT(*) AS view_count,      -- 浏览量(PV)
        SUM(l.stay_time) AS total_stay_time,  -- 总停留时长
        COUNT(DISTINCT l.user_id) AS visitor_count,  -- 访客数(UV)
        AVG(l.stay_time) AS avg_stay_time,  -- 平均停留时长
        COUNT(DISTINCT CASE WHEN l.is_order = 1 THEN l.user_id END) AS order_buyer_count,  -- 下单买家数
        ROUND(                       -- 下单转化率
        COUNT(DISTINCT CASE WHEN l.is_order = 1 THEN l.user_id END) /
        NULLIF(COUNT(DISTINCT l.user_id), 0) * 100,
        2
        ) AS conversion_rate_percent
    FROM log l
    WHERE
        l.is_wireless = 1            -- 限定无线端数据
        AND l.page_type NOT IN ('首页', '活动页', '分类页', '新品页', '商品详情页', '宝贝页')  -- 排除已知类型
    GROUP BY
        l.shop_id,
        l.page_type
    ORDER BY
        view_count DESC;

3.店内路径
    
    -- 1. 标记用户会话和页面访问顺序
    WITH user_sessions AS (
        SELECT
        user_id,
        shop_id,
        page_id,
        page_type,
        visitor_time,
        is_order,
        -- 使用30分钟无操作作为会话分割点
        UNIX_TIMESTAMP(visitor_time) -
        LAG(UNIX_TIMESTAMP(visitor_time), 1, 0) OVER (
            PARTITION BY user_id, shop_id ORDER BY visitor_time
        ) AS time_diff,
        -- 会话内页面访问顺序
        ROW_NUMBER() OVER (
            PARTITION BY user_id, shop_id, session_id ORDER BY visitor_time
        ) AS page_seq
    FROM (
        SELECT
        *,
        -- 通过时间窗口生成会话ID
        SUM(CASE WHEN time_diff > 1800 THEN 1 ELSE 0 END) OVER (
            PARTITION BY user_id, shop_id ORDER BY visitor_time
        ) AS session_id
    FROM (
        SELECT
        *,
        UNIX_TIMESTAMP(visitor_time) -
        LAG(UNIX_TIMESTAMP(visitor_time), 1, 0) OVER (
            PARTITION BY user_id, shop_id ORDER BY visitor_time
        ) AS time_diff
    FROM log
    WHERE is_wireless = 1
    ) t1
    ) t2
    ),
    
    -- 2. 提取路径关系（来源页→目标页）
    page_transitions AS (
        SELECT
        shop_id,
        LAG(page_type, 1, '外部') OVER (
        PARTITION BY user_id, shop_id, session_id ORDER BY visitor_time
    ) AS referrer_type,  -- 来源页面类型
    page_type AS target_type,  -- 目标页面类型
    page_seq,
    is_order
    FROM user_sessions
    )
    
    -- 3. 统计路径指标
    SELECT
    referrer_type,
    target_type,
    COUNT(*) AS transition_count,  -- 跳转次数
    COUNT(DISTINCT user_id) AS unique_users,  -- 涉及用户数
    SUM(CASE WHEN is_order = 1 THEN 1 ELSE 0 END) AS order_count,  -- 订单数
    ROUND(SUM(CASE WHEN is_order = 1 THEN 1 ELSE 0 END) / COUNT(*), 4) AS transition_conversion  -- 跳转转化率
    FROM page_transitions
    WHERE page_seq > 1  -- 排除入店页（无来源）
    GROUP BY referrer_type, target_type
    ORDER BY transition_count DESC;


**pc端数据**

1.展示pc端访客的来源页面TOP20和来源占比图
        
        -- 统计PC端访客的来源页面TOP20及占比
        WITH pc_total AS (
            -- 计算PC端总访问量（用于计算占比）
             SELECT COUNT(*) AS total_visits
        FROM log
        WHERE 
            is_wireless = 0  -- 0表示PC端
        )
        SELECT
            referrer_page_type AS 来源页面类型,
            referrer_page_id AS 来源页面ID,
            visit_count AS 访问次数,
            ROUND(visit_count / total_visits * 100, 2) AS 占比(%)
        FROM (
        -- 统计各来源页面的访问次数
        SELECT
            LAG(page_type) OVER (
            PARTITION BY user_id ORDER BY visitor_time
            ) AS referrer_page_type,  -- 来源页面类型
            LAG(page_id) OVER (
            PARTITION BY user_id ORDER BY visitor_time
            ) AS referrer_page_id,  -- 来源页面ID
            COUNT(*) AS visit_count
        FROM log
        WHERE
            is_wireless = 0  -- 限定PC端
            AND LAG(page_id) OVER (PARTITION BY user_id ORDER BY visitor_time) IS NOT NULL  -- 排除无来源的首次访问
        GROUP BY 
            referrer_page_type, referrer_page_id
        ORDER BY 
            visit_count DESC
        LIMIT 20  -- 取TOP20
        ) t
        JOIN pc_total
        ON 1=1
        ORDER BY 
            访问次数 DESC;

2、PC 端页面访问排行（按浏览量排序）

    sql
    -- 统计PC端各页面的浏览量、访客量、平均停留时长
        SELECT
            page_type AS 页面类型,
            page_id AS 页面ID,
            COUNT(*) AS 浏览量(PV),
            COUNT(DISTINCT user_id) AS 访客量(UV),
            ROUND(AVG(stay_time), 2) AS 平均停留时长(秒),
            SUM(stay_time) AS 总停留时长(秒)
        FROM log
        WHERE 
            is_wireless = 0  -- 限定PC端
        GROUP BY 
            page_type, page_id
        ORDER BY 
            浏览量(PV) DESC;

3.PC 端转化指标（按页面类型统计）

    sql
    -- 统计PC端各页面的下单转化情况
    SELECT
        page_type AS 页面类型,
        COUNT(DISTINCT user_id) AS 访客量(UV),
        COUNT(DISTINCT CASE WHEN is_order = 1 THEN user_id END) AS 下单买家数,
        ROUND(
        COUNT(DISTINCT CASE WHEN is_order = 1 THEN user_id END) /
        NULLIF(COUNT(DISTINCT user_id), 0) * 100,
        2
        ) AS 下单转化率(%)
    FROM log
    WHERE 
        is_wireless = 0  -- 限定PC端
    GROUP BY 
        page_type
    ORDER BY 
        下单买家数 DESC;